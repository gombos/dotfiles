if grep -qs "${1} " /proc/mounts; then
  sudo umount -v ${1}?*
fi

if grep -qs "${1} " /proc/mounts; then
  echo "eject failed!"
  exit
fi

if [ -f /usr/bin/udisksctl ]; then
  sudo udisksctl power-off -b ${1}
  exit
fi

DRIVE=$(echo ${1} | cut -d'/' -f3)
SYSDRIVE=$(readlink -f /sys/class/block/${DRIVE} | cut -d/ -f-9 )

sudo blockdev --flushbufs ${1}

# SCSI removable disk
sudo /usr/bin/eject ${1}
if ! [ -d ${1} ]; then
  exit
fi

# -- SCSI layer

# send SCSI SYNCHRONIZE CACHE command
sudo sg_sync ${1}

#  stop (spin-down)
sudo sg_start --stop ${1}

# stop the medium and eject it from the drive. Only appropriate for a device with removable medium
sudo sg_start --eject ${1}
sleep 2

# -- USB layer

# suspends the USB device (power)
echo 'offline' | sudo tee /sys/block/${DRIVE}/device/state

# logically disables/removes it from its USB port
echo 1 | sudo tee /sys/block/${DRIVE}/device/delete

# -- PCI layer

# Remove PCI device
echo 1 | sudo tee ${SYSDRIVE}/remove

# su -c "echo 1 > /sys/bus/usb/drivers/usb/2-1.3/remove"
# cd /sys/bus/pci/drivers
# echo "$i" > unbind
