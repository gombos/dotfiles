ARG BASE=ghcr.io/gombos/rootfsextra

FROM ghcr.io/gombos/rootfsconfig as r
FROM ghcr.io/gombos/rootfscoreconfig as rcore

FROM ghcr.io/initramfs-modules/initramfs:latest as initrd

# compression takes 10 min
FROM alpine as pra
COPY --from=r / /rootfs
COPY --from=rcore / /rootfscore
RUN apk add squashfs-tools rsync
RUN rsync -ac /rootfs/etc/  /rootfscore/etc
RUN rsync -ac /rootfs/var/  /rootfscore/var
RUN mkdir -p /rootfsdelta/usr
RUN rsync -acn --info=NAME /rootfs/usr/ /rootfscore/usr | cut -d' ' -f1  > /tmp/filelist
RUN rsync -qlptgoD --no-dirs --files-from=/tmp/filelist /rootfs/usr /rootfsdelta/usr/ ; exit 0
RUN mkdir -p /rootfsdelta/usr/lib/extension-release.d/ && echo "ID=_any" > /rootfsdelta/usr/lib/extension-release.d/extension-release.sysext && echo "ARCHITECTURE=_any" >> /rootfsdelta/usr/lib/extension-release.d/extension-release.sysext
RUN rm -rf /rootfsdelta/usr/lib/os-release && rm -rf /rootfsdelta/usr/lib/modules && ln -sf /run/initramfs/modules /rootfsdelta/usr/lib/modules && mksquashfs /rootfsdelta /tmp/sysext.raw -comp zstd
RUN touch /rootfscore/etc/hosts && rm -rf /rootfscore/etc/resolv.conf /rootfscore/usr/lib/firmware/* && mksquashfs /rootfscore /tmp/squashfs.img -comp zstd

FROM scratch as pr
COPY --from=pra /tmp/squashfs.img /iso/squashfs.img
COPY --from=pra /tmp/sysext.raw /iso/sysext.raw

FROM ghcr.io/gombos/boot as efi
FROM ghcr.io/gombos/kernel as kernel
FROM ghcr.io/gombos/ki as kernelinitramfs

FROM $BASE as builder

COPY --from=pr /iso /iso
COPY --from=efi /efi /efi
COPY --from=kernel /boot /boot
COPY --from=kernelinitramfs /efi /efi
COPY --from=initrd /efi /efi

ENV REPO=/_tmp
COPY . $REPO/
RUN $REPO/containers/infra-image.sh

FROM scratch
COPY --from=builder /tmp/linux.iso /tmp/linux.iso
