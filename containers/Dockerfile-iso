ARG BASE=ghcr.io/gombos/rootfs

FROM ghcr.io/gombos/rootfs as r

# compression takes 10 min
FROM alpine as pra
COPY --from=r / /rootfs
RUN apk add squashfs-tools && mksquashfs /rootfs /tmp/squashfs.img -comp zstd

FROM scratch as pr
COPY --from=pra /tmp/squashfs.img /iso/squashfs.img

FROM ghcr.io/gombos/boot as efi
FROM ghcr.io/gombos/usrlocal as usrlocal
FROM ghcr.io/gombos/kernel as kernel
FROM ghcr.io/gombos/kernelinitramfs as kernelinitramfs

FROM $BASE as builder

COPY --from=pr /iso /iso
COPY --from=efi /efi /efi
COPY --from=usrlocal /iso /iso
COPY --from=kernel /boot /boot
COPY --from=kernelinitramfs /efi /efi

ENV REPO=/_tmp
COPY . $REPO/
RUN $REPO/containers/infra-image.sh

FROM scratch
COPY --from=builder /tmp/linux.iso /tmp/linux.iso
