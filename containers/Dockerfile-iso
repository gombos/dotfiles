ARG BASE=ghcr.io/gombos/rootfsextra

FROM ghcr.io/gombos/rootfsconfig as r
FROM ghcr.io/gombos/rootfscoreconfig as rcore

FROM ghcr.io/initramfs-modules/initramfs:latest as initrd

# compression takes 10 min
FROM alpine as pra
COPY --from=r / /rootfs
COPY --from=rcore / /rootfscore
RUN apk add squashfs-tools rsync
RUN rsync -avc /rootfs/etc/  /rootfscore/etc
RUN rsync -avnc /rootfscore/usr/bin/ /rootfs/usr/bin > /tmp/filelist
RUN cat /tmp/filelist
#RUN touch /rootfs/etc/hosts && rm -rf /rootfs/etc/resolv.conf /rootfs/usr/lib/firmware/* && mksquashfs /rootfs /tmp/squashfs.img -comp zstd

#FROM scratch as pr
#COPY --from=pra /tmp/squashfs.img /iso/squashfs.img

#FROM ghcr.io/gombos/boot as efi
#FROM ghcr.io/gombos/kernel as kernel
#FROM ghcr.io/gombos/ki as kernelinitramfs

#FROM $BASE as builder

#COPY --from=pr /iso /iso
#COPY --from=efi /efi /efi
#COPY --from=kernel /boot /boot
#COPY --from=kernelinitramfs /efi /efi
#COPY --from=initrd /efi /efi

#ENV REPO=/_tmp
#COPY . $REPO/
#RUN $REPO/containers/infra-image.sh

#FROM scratch
#COPY --from=builder /tmp/linux.iso /tmp/linux.iso
